name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: production
    env:
      IMAGE_TAG: ${{ github.event.workflow_run.head_sha || github.sha }}
      REGISTRY: ghcr.io
      OWNER: ${{ github.repository_owner }}
      PROD_APP_DIR: ${{ secrets.PROD_APP_DIR }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/gym-erp-backend:${{ env.IMAGE_TAG }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/gym-erp-frontend:${{ env.IMAGE_TAG }}

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}

      - name: Copy production compose file
        run: |
          ssh-keyscan -H "${{ secrets.PROD_SSH_HOST }}" >> ~/.ssh/known_hosts
          scp docker-compose.prod.yml "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}:${{ secrets.PROD_APP_DIR }}/docker-compose.prod.yml"

      - name: Deploy to production host
        run: |
          ssh "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}" <<EOF
          set -euo pipefail
          cd "${PROD_APP_DIR}"
          mkdir -p static
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          if [ -f .deploy-images.current.env ]; then
            cp .deploy-images.current.env .deploy-images.previous.env
          fi
          cat > .deploy-images.current.env <<EOCFG
          BACKEND_IMAGE=ghcr.io/${OWNER}/gym-erp-backend:${IMAGE_TAG}
          FRONTEND_IMAGE=ghcr.io/${OWNER}/gym-erp-frontend:${IMAGE_TAG}
          EOCFG
          docker compose --env-file .env --env-file .deploy-images.current.env -f docker-compose.prod.yml pull
          docker compose --env-file .env --env-file .deploy-images.current.env -f docker-compose.prod.yml up -d db
          docker compose --env-file .env --env-file .deploy-images.current.env -f docker-compose.prod.yml run --rm backend alembic upgrade head
          docker compose --env-file .env --env-file .deploy-images.current.env -f docker-compose.prod.yml up -d backend frontend
          curl -fsS http://127.0.0.1:8000/healthz
          curl -fsS http://127.0.0.1:3000/login > /dev/null
          EOF

      - name: Roll back on failed smoke check
        if: failure()
        run: |
          ssh "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}" <<EOF
          set -euo pipefail
          cd "${PROD_APP_DIR}"
          if [ ! -f .deploy-images.previous.env ]; then
            exit 0
          fi
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker compose --env-file .env --env-file .deploy-images.previous.env -f docker-compose.prod.yml pull
          docker compose --env-file .env --env-file .deploy-images.previous.env -f docker-compose.prod.yml up -d db backend frontend
          EOF

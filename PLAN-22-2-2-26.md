## Plan: Roles + Dashboard Metrics + Daily Visitor Report + WhatsApp Automation + Multi-Channel Feedback

### Summary
Implement five coordinated upgrades:
1. Split confusing dashboard user metric into a stable non-live KPI (`today_visitors`) while keeping `live_headcount` separately.
2. Add explicit roles: `CASHIER` and `RECEPTION` (registration/front office).
3. Add daily visitor reporting based on **unique granted members per day**, no live data.
4. Add WhatsApp automation (phase 1): activity + subscription transactional messages.
5. Add three feedback channels: workout feedback, diet feedback, and full gym feedback.

Chosen defaults from your decisions:
- Role model: explicit new roles.
- WhatsApp phase 1 scope: activity + subscription only.
- Feedback model: three separate channels.
- Visitor metric: unique granted members/day.
- Dashboard KPI replacement: today visitors (non-live).
- Reporting timezone: gym local timezone.

### Public API / Interface Changes
- Extend role enum with `CASHIER`, `RECEPTION` while keeping existing roles for backward compatibility.
- `GET /analytics/dashboard` response adds:
- `today_visitors: number` (unique granted visitors for current local day).
- Keep `live_headcount` unchanged.
- New endpoint `GET /analytics/daily-visitors`:
- Query: `from`, `to`, optional `group_by` (`day|week`), optional `format` (`json|csv`).
- Returns non-live aggregates only.
- New feedback APIs:
- `POST /fitness/diet-feedback` and `GET /fitness/diet-feedback` (coach/admin view with member/plan filters).
- `POST /fitness/gym-feedback` and `GET /fitness/gym-feedback` (member submits, admin/coach view).
- Keep existing workout feedback APIs unchanged.
- WhatsApp integration interfaces:
- Provider abstraction service (`send_template_message(to, template_key, params)`).
- Event-driven trigger points from access/subscription flows.
- Delivery logs endpoint for admin visibility (read-only) `GET /admin/notifications/whatsapp-logs`.

### Backend Implementation Plan
- Add Alembic migration for role enum values and any new feedback/log tables.
- Add role-safe backward compatibility:
- Existing `FRONT_DESK` users remain valid.
- New registrations can use `RECEPTION`.
- RBAC updates:
- POS and sales: `ADMIN`, `CASHIER` (optionally `EMPLOYEE` temporarily during transition).
- Registration/member onboarding: `ADMIN`, `RECEPTION`.
- Keep audit and finance-sensitive operations restricted appropriately.
- Analytics service updates:
- Compute `today_visitors` from distinct `AccessLog.user_id` where `status='GRANTED'` and `scan_time` in local-day range.
- Keep `live_headcount` as currently modeled.
- Add `daily-visitors` aggregation query with timezone-aware day boundaries.
- Feedback modeling:
- Add `DietFeedback` table linked to member + diet plan + optional coach.
- Add `GymFeedback` table linked to member, rating + comment + optional category.
- Add list filters (date range, member, coach, plan, minimum rating).
- WhatsApp automation:
- Add config flags: provider creds, enable/disable, dry-run mode.
- Add outbox/delivery log table for idempotent sends and auditability.
- Trigger messages on:
- Successful access grant (activity message).
- Subscription create/renew/freeze/activate/expiry transitions.
- Add retry policy and dead-letter status in logs.

### Frontend Implementation Plan
- Admin dashboard (`frontend/src/app/dashboard/page.tsx`):
- Replace confusing “current users” KPI usage with `today_visitors`.
- Keep `Live Headcount` card as real-time/live visual.
- Add clear labels:
- `Today Visitors (Non-Live)`
- `Live Headcount`
- Add Daily Visitor Report UI:
- Date range selector.
- Table + simple chart.
- CSV export button.
- Navigation and role-aware UI (`frontend/src/app/dashboard/layout.tsx`):
- Add role visibility for cashier/reception pages/actions.
- Rename labels for clarity (Reception/Registration, Cashier POS).
- Feedback pages:
- Extend coach feedback page with tabs: Workout, Diet, Gym.
- Add member-facing forms for diet and gym feedback submission.
- Add admin overview filter panel.

### Data / Migration Notes
- Add gym timezone config (single org-level setting) used by analytics/reporting.
- Keep legacy roles supported in DB and UI mapping during transition.
- Add indexes:
- `access_logs(status, scan_time, user_id)`
- Feedback tables by `created_at`, `member_id`, `coach_id` as relevant.
- Add WhatsApp log uniqueness key for idempotency (event_type + user_id + event_ref + date bucket).

### Test Cases and Scenarios
- Analytics:
- Dashboard returns both `live_headcount` and `today_visitors` with correct distinct-user logic.
- Daily visitors excludes denied scans and duplicate scans for same user/day.
- Timezone boundary test around midnight local time.
- Role/RBAC:
- `CASHIER` can execute POS flows but cannot access admin-only resources.
- `RECEPTION` can perform registration/member operations but not finance/audit admin routes.
- Legacy `FRONT_DESK` still works where expected.
- Feedback:
- Member can submit diet/gym feedback; unauthorized users blocked.
- Coach/admin can query filtered feedback lists.
- Workout feedback unchanged regression tests.
- WhatsApp:
- On activity/subscription events, outbox record created once (idempotent).
- Provider failure triggers retry and logged failure state.
- Dry-run mode logs without external send.
- UI:
- Dashboard shows non-live visitors and live headcount as separate values.
- Report date filters and CSV export work for expected dataset.

### Assumptions and Defaults
- “Current users” confusion is resolved by replacing that KPI with `today_visitors` and clearer card naming.
- Daily visitor report uses `AccessLog` granted scans, not attendance logs.
- Reporting is non-live by design and uses configured gym local timezone.
- Advertisement/campaign WhatsApp messaging is postponed to phase 2; architecture remains ready for it.
- Existing users/roles/data remain valid after migration; no destructive role remap.

### Suggested Next Additions (after this phase)
1. Add campaign manager for opt-in promotional WhatsApp messaging (templates, audience segments, quiet hours).
2. Add SLA dashboard for notification delivery success/failure rates.
3. Add NPS-style monthly gym feedback pulse and trend line on admin dashboard.
